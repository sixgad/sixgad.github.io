<!DOCTYPE html>
<html>

<head>

  <!-- Meta Tag -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <!-- SEO -->
  <meta name="description" content="爬客,个人学习记录与分享python,web,spider,爬虫,逆向,工具脚本等技术的博客。">
  <meta name="author" content="zp">


  <title>如何构造mmc4形式的多模态数据集</title>

  <link rel="stylesheet" type="text/css" href="../../static/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="../../static/css/github.css">

  <!-- Favicon -->
  <link rel="shortcut icon" href="../../static/images/favicon/favicon.ico">
  <link rel="apple-touch-icon" sizes="144x144" type="image/x-icon"
    href="../../static/images/favicon/apple-touch-icon.png">

  <!-- All CSS Plugins -->
  <link rel="stylesheet" type="text/css" href="../../static/css/plugin.css">

  <!-- Main CSS Stylesheet -->
  <link rel="stylesheet" type="text/css" href="../../static/css/style.css">

  <!-- Google Web Fonts  -->
  <link rel="stylesheet" href="../../static/css/ft.css">


</head>

<body>



  <!-- Preloader Start -->
  <div class="preloader">
    <div class="rounder"></div>
  </div>
  <!-- Preloader End -->




  <div id="main">
    <div class="container">
      <div class="row">



        <!-- About Me (Left Sidebar) Start -->
        <div class="col-md-3">
          <div class="about-fixed">

            <div class="my-pic">
              <img src="../../static/images/top/270-229.png" alt="">
              <!-- <a href="javascript:void(0)" class="collapsed" data-target="#menu" data-toggle="collapse"><i
                  class="icon-menu menu"></i></a> -->
              <!-- <div id="menu" class="collapse">
                <ul class="menu-link">
                  <li><a href="about.html">About</a></li>
                  <li><a href="work.html">Work</a></li>
                  <li><a href="contact.html">Contact</a></li>
                </ul>
              </div> -->
            </div>



            <div class="my-detail">

              <div class="white-spacing">
                <span class="my-sub-title">雪重</span>
                <span class="my-sub-title">Python Developer</span>
                <span class="my-sub-title">知识 汗水 灵感 机遇</span>
              </div>

              <ul class="social-icon">
                <li><a href="https://github.com/sixgad" target="_blank" class="github"><i class="fa fa-github"></i></a>
                </li>
                <!-- <li><a href="#" target="_blank" class="github"><i class="fa fa-qq"></i></a></li> -->
                <li><a href="mailto:278270230@qq.com" target="_blank" class="github"><i class="fa fa-envelope"></i></a>
                </li>
              </ul>

            </div>
          </div>
        </div>
        <!-- About Me (Left Sidebar) End -->





        <!-- Blog Post (Right Sidebar) Start -->
        <div class="col-md-9">
          <div class="col-md-12 page-body">
            <div class="row">


              <div class="sub-title">
                <a href="../../index.html" title="Go to Home Page">
                  <h1>Back Home</h1>
                </a>
                <!-- <a href="#comment" class="smoth-scroll"><i class="icon-bubbles"></i></a> -->
              </div>

              <div class="col-md-12 content-page">


                <!-- Blog Post Start -->
                <!-- <div class="col-md-12 blog-post">
                  <div class="post-info">
                  </div>
                    博客正文预留位置

                </div> -->

                <div class="blog-cc">
                  <span>2023年9月26日</span>&nbsp;&nbsp;<i class="fa fa-tags"></i>&nbsp;<span><a>数据集</a></span>

                  <h1 id="mmc4">如何构造mmc4形式的多模态数据集</h1>
<p>mmc4数据集【https://github.com/allenai/mmc4】是一个扩展了仅文本C4语料库的数据集，其中交错了图像和文本。该数据集涵盖了日常主题，如烹饪、旅行、科技等，在过滤掉NSFW图像、广告等后，该语料库包含103M个文档，其中交错了585M个图像和43B个英语标记。</p>
<p>数据格式如下</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="err">&#39;image_i</span><span class="kc">nf</span><span class="err">o&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="err">&#39;</span><span class="kc">fa</span><span class="err">ce_de</span><span class="kc">te</span><span class="err">c</span><span class="kc">t</span><span class="err">io</span><span class="kc">ns</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">No</span><span class="kc">ne</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="err">&#39;image_</span><span class="kc">na</span><span class="err">me&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;b</span><span class="mi">9040</span><span class="err">a</span><span class="mi">0</span><span class="err">dbb</span><span class="mf">22.</span><span class="err">jpg&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="err">&#39;ma</span><span class="kc">t</span><span class="err">ched_sim&#39;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.27694183588027954</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="err">&#39;ma</span><span class="kc">t</span><span class="err">ched_</span><span class="kc">te</span><span class="err">x</span><span class="kc">t</span><span class="err">_i</span><span class="kc">n</span><span class="err">dex&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="err">&#39;raw_url&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;h</span><span class="kc">tt</span><span class="err">p</span><span class="p">:</span><span class="c1">//www.hfitinfo.com/honda_fit_pics/3/2/index.90.jpg&#39;},</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="err">&#39;</span><span class="kc">fa</span><span class="err">ce_de</span><span class="kc">te</span><span class="err">c</span><span class="kc">t</span><span class="err">io</span><span class="kc">ns</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">No</span><span class="kc">ne</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="err">&#39;image_</span><span class="kc">na</span><span class="err">me&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;db</span><span class="mi">1</span><span class="err">c</span><span class="mi">21</span><span class="err">bc</span><span class="mf">8474.</span><span class="err">jpg&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="err">&#39;ma</span><span class="kc">t</span><span class="err">ched_sim&#39;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.3234919607639313</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="err">&#39;ma</span><span class="kc">t</span><span class="err">ched_</span><span class="kc">te</span><span class="err">x</span><span class="kc">t</span><span class="err">_i</span><span class="kc">n</span><span class="err">dex&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="err">&#39;raw_url&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;h</span><span class="kc">tt</span><span class="err">p</span><span class="p">:</span><span class="c1">//www.hfitinfo.com/honda_fit_pics/3/2/index.91.jpg&#39;}],</span><span class="w"></span>
<span class="w"> </span><span class="err">&#39;similari</span><span class="kc">t</span><span class="err">y_ma</span><span class="kc">tr</span><span class="err">ix&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[[</span><span class="mf">0.24363446235656738</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="mf">0.31758785247802734</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="mf">0.27694183588027954</span><span class="p">],</span><span class="w"></span>
<span class="w">                       </span><span class="p">[</span><span class="mf">0.2233106791973114</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="mf">0.3234919607639313</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="mf">0.26118797063827515</span><span class="p">]],</span><span class="w"></span>
<span class="w"> </span><span class="err">&#39;</span><span class="kc">te</span><span class="err">x</span><span class="kc">t</span><span class="err">_lis</span><span class="kc">t</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">&#39;Whe</span><span class="kc">n</span><span class="w"> </span><span class="err">you</span><span class="w"> </span><span class="err">lock</span><span class="w"> </span><span class="kc">t</span><span class="err">he</span><span class="w"> </span><span class="err">door</span><span class="w"> </span><span class="err">usi</span><span class="kc">n</span><span class="err">g</span><span class="w"> </span><span class="kc">t</span><span class="err">he</span><span class="w"> </span><span class="err">lock</span><span class="w"> </span><span class="kc">ta</span><span class="err">b</span><span class="w"> </span><span class="err">o</span><span class="kc">n</span><span class="w"> </span><span class="kc">t</span><span class="err">he</span><span class="w"> </span><span class="err">driver’s</span><span class="w"> </span><span class="err">&#39;</span><span class="w"></span>
<span class="w">               </span><span class="err">&#39;door</span><span class="p">,</span><span class="w"> </span><span class="err">all</span><span class="w"> </span><span class="err">o</span><span class="kc">f</span><span class="w"> </span><span class="kc">t</span><span class="err">he</span><span class="w"> </span><span class="err">o</span><span class="kc">t</span><span class="err">her</span><span class="w"> </span><span class="err">doors</span><span class="w"> </span><span class="err">a</span><span class="kc">n</span><span class="err">d</span><span class="w"> </span><span class="kc">ta</span><span class="err">ilga</span><span class="kc">te</span><span class="w"> </span><span class="err">lock</span><span class="w"> </span><span class="err">a</span><span class="kc">t</span><span class="w"> </span><span class="kc">t</span><span class="err">he</span><span class="w"> </span><span class="err">same</span><span class="w"> </span><span class="err">&#39;</span><span class="w"></span>
<span class="w">               </span><span class="err">&#39;</span><span class="kc">t</span><span class="err">ime.&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="err">&#39;Press</span><span class="w"> </span><span class="kc">t</span><span class="err">he</span><span class="w"> </span><span class="err">mas</span><span class="kc">ter</span><span class="w"> </span><span class="err">door</span><span class="w"> </span><span class="err">lock</span><span class="w"> </span><span class="err">swi</span><span class="kc">t</span><span class="err">ch</span><span class="w"> </span><span class="err">i</span><span class="kc">n</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">show</span><span class="kc">n</span><span class="w"> </span><span class="kc">t</span><span class="err">o</span><span class="w"> </span><span class="err">lock</span><span class="w"> </span><span class="err">or</span><span class="w"> </span><span class="err">&#39;</span><span class="w"></span>
<span class="w">               </span><span class="err">&#39;u</span><span class="kc">nl</span><span class="err">ock</span><span class="w"> </span><span class="err">all</span><span class="w"> </span><span class="err">doors</span><span class="w"> </span><span class="err">a</span><span class="kc">n</span><span class="err">d</span><span class="w"> </span><span class="kc">t</span><span class="err">he</span><span class="w"> </span><span class="kc">ta</span><span class="err">ilga</span><span class="kc">te</span><span class="err">.&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="err">&#39;Whe</span><span class="kc">n</span><span class="w"> </span><span class="err">you</span><span class="w"> </span><span class="err">lock/u</span><span class="kc">nl</span><span class="err">ock</span><span class="w"> </span><span class="kc">t</span><span class="err">he</span><span class="w"> </span><span class="err">driver’s</span><span class="w"> </span><span class="err">door</span><span class="w"> </span><span class="err">a</span><span class="kc">n</span><span class="err">d</span><span class="w"> </span><span class="kc">ta</span><span class="err">ilga</span><span class="kc">te</span><span class="w"> </span><span class="err">usi</span><span class="kc">n</span><span class="err">g</span><span class="w"> </span><span class="kc">t</span><span class="err">he</span><span class="w"> </span><span class="err">&#39;</span><span class="w"></span>
<span class="w">               </span><span class="err">&#39;mas</span><span class="kc">ter</span><span class="w"> </span><span class="err">lock</span><span class="w"> </span><span class="err">swi</span><span class="kc">t</span><span class="err">ch</span><span class="p">,</span><span class="w"> </span><span class="err">all</span><span class="w"> </span><span class="kc">t</span><span class="err">he</span><span class="w"> </span><span class="err">o</span><span class="kc">t</span><span class="err">her</span><span class="w"> </span><span class="err">doors</span><span class="w"> </span><span class="err">lock/</span><span class="w"> </span><span class="err">u</span><span class="kc">nl</span><span class="err">ock</span><span class="w"> </span><span class="err">a</span><span class="kc">t</span><span class="w"> </span><span class="kc">t</span><span class="err">he</span><span class="w"> </span><span class="err">&#39;</span><span class="w"></span>
<span class="w">               </span><span class="err">&#39;same</span><span class="w"> </span><span class="kc">t</span><span class="err">ime.&#39;</span><span class="p">],</span><span class="w"></span>
<span class="w"> </span><span class="err">&#39;url&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;h</span><span class="kc">tt</span><span class="err">p</span><span class="p">:</span><span class="c1">//www.hfitinfo.com/hofi-48.html&#39;,</span><span class="w"></span>
<span class="w"> </span><span class="err">&#39;could_have_url_duplica</span><span class="kc">te</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>

<blockquote>
<p>text_list：文本句子列表</p>
<p>similarity_matrix：文本图片相似度矩阵</p>
<p>image_info：图片列表</p>
<p>matched_text_index：表示该图像所匹配的句子的索引</p>
<p>matched_sim：匹配索引处图像与句子之间的相似度</p>
</blockquote>
<p>如何构造一份中文mmc4形式的多模态数据集呢？核心就是计算文本图片相似度矩阵，找到最优匹配。</p>
<p>引入如下工具：</p>
<blockquote>
<p>Chinese-CLIP：https://github.com/OFA-Sys/Chinese-CLIP/tree/master</p>
<p>CLIP模型的中文版本，使用大规模中文数据进行训练（~2亿图文对），旨在帮助用户快速实现中文领域的图文特征&amp;相似度计算、跨模态检索、零样本图片分类等任务</p>
<p>Munkres' Assignment Algorithm，也被称为匈牙利算法（Hungarian Algorithm）</p>
<p>是一种用于解决赋值问题的有效算法。赋值问题是最优化问题的一种，其中的目标是在成本矩阵中找到总成本最小的赋值方案，这个算法保证了在有限的步骤内找到总成本最小的赋值方案。</p>
</blockquote>
<p>代码实现：</p>
<p>1.jpg</p>
<p><img src="1.jpg" alt="1" style="zoom:50%;" /></p>
<p>2.jpg</p>
<p><img src="2.jpg" alt="2" style="zoom:80%;" /></p>
<p>3.jpg</p>
<p><img src="3.jpg" alt="3" style="zoom:80%;" /></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># -*- coding:utf-8 -*-</span>
<span class="c1"># @Author:      zp</span>
<span class="c1"># @Time:        2023/9/26 17:11</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">cn_clip.clip</span> <span class="k">as</span> <span class="nn">clip</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">cn_clip.clip</span> <span class="kn">import</span> <span class="n">load_from_name</span><span class="p">,</span> <span class="n">available_models</span><span class="p">,</span> <span class="n">model</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">linear_sum_assignment</span>

<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;float_kind&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:0.6f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available models:&quot;</span><span class="p">,</span> <span class="n">available_models</span><span class="p">())</span>

<span class="c1"># 加载模型和处理器</span>
<span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;use device&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
<span class="n">model</span><span class="p">,</span> <span class="n">preprocess</span> <span class="o">=</span> <span class="n">load_from_name</span><span class="p">(</span><span class="s2">&quot;ViT-L-14&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">download_root</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="c1"># 加载并处理多个图像</span>
<span class="n">image_paths</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1.jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;2.jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;3.jpg&quot;</span><span class="p">]</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">preprocess</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">image_paths</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># 准备多段文本</span>
<span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;荷花&quot;</span><span class="p">,</span> <span class="s2">&quot;月亮&quot;</span><span class="p">,</span> <span class="s2">&quot;球&quot;</span><span class="p">,</span> <span class="s2">&quot;汽车&quot;</span><span class="p">,</span> <span class="s2">&quot;玩具&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
<span class="n">texts</span> <span class="o">=</span> <span class="n">clip</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># 通过模型获取图像和文本的特征</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">logits_per_image</span><span class="p">,</span> <span class="n">logits_per_text</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_similarity</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">texts</span><span class="p">)</span>
    <span class="n">similarity_matrix</span> <span class="o">=</span> <span class="n">logits_per_image</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">similarity_matrix</span><span class="p">)</span>

<span class="n">row_ind</span><span class="p">,</span> <span class="n">col_ind</span> <span class="o">=</span> <span class="n">linear_sum_assignment</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">similarity_matrix</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">row_ind</span><span class="p">,</span> <span class="n">col_ind</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>

<p><img src="image-20230926171506821.png" alt="image-20230926171506821" style="zoom:80%;" /></p>

                </div>
                <!-- Blog Post End -->
              </div>


            </div>

          </div>


          <!-- Footer Start -->
          <div class="col-md-12 page-body margin-top-50 footer">
            <footer>
              <!-- <ul class="menu-link">
                <li><a href="index.html">Home</a></li>
                <li><a href="about.html">About</a></li>
              </ul> -->

              <p>Copyright © 2021
                <a href="#" target="_blank">爬客</a> All rights reserved
              </p>
              <p>
                <a href="https://beian.miit.gov.cn/#/Integrated/index" rel="nofollow"
                  target="_blank">辽ICP备2021000509号-1</a>
                <img src="../../static/images/top/beian.png"
                  style="display: inline-block;vertical-align: sub;margin-left: 10px;">
                <a target="_blank" href="http://www.beian.gov.cn/portal/index.do" rel="nofollow">辽公网安备
                  21032302210389号</a>
              </p>
              <p>联系邮箱：
                <a href="#" rel="nofollow" target="_blank">278270230@qq.com</a>
              </p>
              <a href="#">
                <div class="top_tag"></div>
              </a>
            </footer>

          </div>
          <!-- Footer End -->


        </div>
        <!-- Blog Post (Right Sidebar) End -->

      </div>
    </div>
  </div>



  <!-- Back to Top Start -->
  <a href="#" class="scroll-to-top"><i class="fa fa-long-arrow-up"></i></a>
  <!-- Back to Top End -->


  <!-- All Javascript Plugins  -->
  <script type="text/javascript" src="../../static/js/jquery.min.js"></script>
  <script type="text/javascript" src="../../static/js/plugin.js"></script>

  <!-- Main Javascript File  -->
  <script type="text/javascript" src="../../static/js/scripts.js"></script>


</body>

</html>